downloadRedminTickets
=====================

RedmineのチケットをCSV形式で標準出力に出力するアプリケーションです。

## 使い方
### 1.環境設定情報を作成する

本アプリケーションは、Redmineへ接続するための情報やチケットを抽出するためのフィルタをファイルをまず作成する必要があります。

環境設定ファイルはprofilesディレクトリ配下にXXX.profileと言う名前で記述してください。XXXに「default」という名前は使用できません。XXXは複数のRedmineに接続したり異なる条件でチケットを取得するような場合に実行時に切り替える事が出来るようになっています。基本同じサーバに対して同じ抽出条件でのみチケットを取得したい場合はXXXにはOSログイン時のユーザー名を指定して頂くと、実行時にパラメータを指定する必要は無くなります（'-'は'_'に変換する必要があります）

なお、環境設定ファイルは、[ConfigSlurper](http://groovy.codehaus.org/ConfigSlurper)を利用して読み込みます。ファイルフォーマットについては、左記サイト等で確認してください。また、profiles/default.profilesを参考にして頂いても結構です。

なお、設定ファイルに日本語を用いる場合はUTF-8で記述するようにしてください。

### 2.環境設定情報その１〜Redmineサーバへ接続するための必須情報〜

本アプリケーションではRedmineへ接続するために以下の情報を必ず環境設定ファイルに記述する必要があります。
 1. redmine.url・・・RedmineサーバのトップURLを記述してください（但し、末尾に「/」は記述しないようにしてください）
 2. redmine.accessKey・・・RedmineサーバへREST APIで接続するためのアクセスキーを記述してください。アクセスキーはRedmine上の個人設定のページで確認可能です。もし、確認できない場合はRedmineの管理者へ問い合わせてください。
 3. redmine.projectKey・・・取得するチケットが登録されているprojectのURL（プロジェクト名ではありません）を記述してください。

### 3.チケットを取得する
本アプリケーションは、ターミナル（Windowsの場合はコマンドプロンプト）にて、以下の用に実行する事ができます。

```gradlew -q -Penv=XXXX run > ticket.csv```

Gradleがインストールされていない環境では、最初にGradleのインストールを行うため実行に時間がかかってしまいますが以降はダウンロードしたGradleを利用してプログラムは実行されます。

-qオプションを指定しないと標準出力に余計な情報が出力されるので、**必ず-qオプションはつけてください**

envパラメタは実行時に利用するプロファイルを指定します。省略した場合は[現在OSにログインしているユーザー名].profileを利用して実行します。

なお、Windows環境ではショートカットコマンドである、run.batを用意しています。
```run XXX > ticket.csv```
と記述して実行する事で上記コマンドと同じ事が出来るようになっています。（XXXの省略はできません）
 
### 4.取得するチケットを絞り込み

基本設定を終えただけでは、プロジェクトに登録されている全てのチケットを取得してきてしまいます。本アプリケーションでは現在以下の２つの方法で取得するチケットの絞り込みを行う事ができます。

### 4.1 サーバ上に登録されているカスタムクエリを利用する

「redmine.queryId」と言う情報を設定する事でRedmine上で設定しているカスタムクエリに応じたチケットの取得を行う事ができます。

### 4.2 OGNL形式による絞り込み

「localFilterRef」という情報を設定する事で取得するチケットを柔軟に設定する事が可能になります。

例えば、

```localFilterRef='tracker.name =="Bug" || tracker.name == "Story"'```

と記述すると、トラッカーがBugもしくはStoryのチケットを取得する事ができます。4.1のカスタムクエリと合わせると、カスタムクエリの条件に合致した物の中でさらに絞り込むと言う事が可能になります。

本アプリケーションではデフォルトでチケットが「未完了もしくは特定スプリントのStoryチケット」（スプリントレビュー用？）のクエリを用意しています。このクエリを利用する場合は、

```
localFilterRef='${localFilter.未完了または特定スプリントの特定トラッカーのチケット}'
trackerName='Story'
versionName='Sprint-X'
```
という記述を行ってください。なお、trackerNameにはそのプロジェクトでストーリーとして扱っているトラッカーの名前、versionNameには、取得対象のバージョン名を記述してください。

### 5. 取得する情報の拡張

redmine.includesと言うエントリを指定する事で、チケットに紐付く各種情報も取得する事ができます。
取得可能な情報は以下の通りです。
 * attachments・・・添付ファイル
 * changesets・・・チェンジセット
 * journals・・・変更履歴
 * relations・・・関連チケット
 * watchers・・・チケットウォッチャー

デフォルトではjournalsを取得するようにしています。

### 6. 並び順の変更

sorterRefと言うエントリを指定する事でチケットの取得順序をONGL形式に基づいて柔軟に変更出来ます。
デフォルトはチケットID順です。

記述方法については、default.profileに記載があるので参考にしてください。

### 7. 取得内容の変更

flatterと言うエントリを指定する事で、CSVに出力するカラムをOGNL形式に基づいて柔軟に変更出来ます。
デフォルトは、以下の内容を取得しています。

 * チケットID
 * チケット名
 * 状態
 * チケット作成日
 * チケット作成者
 * チケット最終更新日
 * スプリント
 * メモ・・・（コメントがある履歴の内容（更新日、更新者、メモ）を時系列に並べています。

記述方法についてはdefault.profileに記述があるので参考にしてください。 
 

